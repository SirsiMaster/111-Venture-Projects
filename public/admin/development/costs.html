<!DOCTYPE html>
<html lang="en" data-auth-protect="admin">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Development Costs â€” FinalWishes</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="../../finalwishes.css">
    <link rel="stylesheet" href="../../assets/css/admin-layout.css?v=5.0.0">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div class="admin-wrapper">
        <div id="sidebar-root" data-active="dev-costs"></div>
        
        <main class="main-content">
            <header id="universal-header-root" 
                    data-title="Development Costs" 
                    data-subtitle="Track AI-assisted development costs and projections"
                    data-search-placeholder="Search cost entries..."></header>
            
            <div class="page-content">
                <!-- Budget Overview -->
                <div class="stats-grid">
                    <div class="stat-card highlight">
                        <div class="stat-icon gold">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                            </svg>
                        </div>
                        <div class="stat-value" id="total-spent">$0</div>
                        <div class="stat-label">Total Spent</div>
                        <div class="stat-change" id="spent-percent">0% of budget</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                        </div>
                        <div class="stat-value" id="this-month">$0</div>
                        <div class="stat-label">This Month</div>
                        <div class="stat-change" id="month-change">+$0 vs last</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                        </div>
                        <div class="stat-value" id="avg-daily">$0</div>
                        <div class="stat-label">Avg Daily Cost</div>
                        <div class="stat-change" id="daily-hours">0h avg/day</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon red">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                            </svg>
                        </div>
                        <div class="stat-value" id="projected-total">$0</div>
                        <div class="stat-label">Projected Total</div>
                        <div class="stat-change" id="remaining-budget">$0 remaining</div>
                    </div>
                </div>
                
                <!-- Budget Progress -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Budget Progress</h3>
                        <div class="budget-info">
                            <span>Budget: <strong>$80,000 - $100,000</strong></span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="budget-bar-container">
                            <div class="budget-bar">
                                <div class="budget-fill" id="budget-fill" style="width: 0%"></div>
                                <div class="budget-projected" id="budget-projected" style="left: 0%"></div>
                            </div>
                            <div class="budget-markers">
                                <span>$0</span>
                                <span>$20K</span>
                                <span>$40K</span>
                                <span>$60K</span>
                                <span>$80K</span>
                                <span>$100K</span>
                            </div>
                        </div>
                        <div class="budget-legend">
                            <div class="legend-item">
                                <span class="legend-color spent"></span>
                                <span>Spent</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color projected"></span>
                                <span>Projected</span>
                            </div>
                            <div class="legend-item">
                                <span class="legend-color remaining"></span>
                                <span>Remaining</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div class="row-2">
                    <!-- Monthly Breakdown -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Monthly Breakdown</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="monthlyChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cost by Agent/Domain -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Cost by Domain</h3>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" style="height: 250px;">
                                <canvas id="domainChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Cost Projections -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Cost Projections</h3>
                        <select id="projectionRange" class="form-select mini" onchange="updateProjections()">
                            <option value="completion">To Completion</option>
                            <option value="30">30 Days</option>
                            <option value="60">60 Days</option>
                            <option value="90">90 Days</option>
                        </select>
                    </div>
                    <div class="card-body">
                        <div class="projections-grid">
                            <div class="projection-card">
                                <h4>Conservative</h4>
                                <div class="projection-value" id="proj-conservative">$0</div>
                                <p class="projection-desc">Based on current pace</p>
                            </div>
                            <div class="projection-card highlight">
                                <h4>Expected</h4>
                                <div class="projection-value" id="proj-expected">$0</div>
                                <p class="projection-desc">With efficiency gains</p>
                            </div>
                            <div class="projection-card">
                                <h4>Optimistic</h4>
                                <div class="projection-value" id="proj-optimistic">$0</div>
                                <p class="projection-desc">Best case scenario</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Cost Details Table -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Cost Details</h3>
                        <button class="btn btn-sm btn-secondary" onclick="exportCosts()">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Export
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="data-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Hours</th>
                                        <th>Rate</th>
                                        <th>Cost</th>
                                        <th>Domain</th>
                                        <th>Running Total</th>
                                    </tr>
                                </thead>
                                <tbody id="costs-table">
                                    <tr>
                                        <td colspan="6" style="text-align: center; padding: var(--space-xl);">Loading...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script src="../../components/sidebar.js"></script>
    <script src="../../components/universal-header.js"></script>
    
    <script type="module">
        import DevelopmentMetricsService from '../../assets/js/services/developmentMetricsService.js';
        
        window.MetricsService = DevelopmentMetricsService;
        
        const BUDGET_MIN = 80000;
        const BUDGET_MAX = 100000;
        const HOURLY_RATE = 150;
        
        let sessions = [];
        let monthlyChart = null;
        let domainChart = null;
        
        async function init() {
            console.log('ðŸ›ï¸ FinalWishes - Development Costs');
            await loadCostData();
            initCharts();
            updateProjections();
        }
        
        async function loadCostData() {
            try {
                sessions = await DevelopmentMetricsService.getAllSessions();
                const totals = await DevelopmentMetricsService.getProjectTotals();
                const costBreakdown = await DevelopmentMetricsService.getCostBreakdown();
                
                updateStats(totals, costBreakdown);
                renderCostsTable();
            } catch (error) {
                console.error('Error loading cost data:', error);
                // Use fallback data
                useFallbackData();
            }
        }
        
        function useFallbackData() {
            // Demo data
            const totalSpent = 37125;
            const thisMonth = 8475;
            const avgDaily = 675;
            
            document.getElementById('total-spent').textContent = '$' + totalSpent.toLocaleString();
            document.getElementById('spent-percent').textContent = Math.round((totalSpent / BUDGET_MAX) * 100) + '% of budget';
            document.getElementById('this-month').textContent = '$' + thisMonth.toLocaleString();
            document.getElementById('month-change').textContent = '+$2,100 vs last';
            document.getElementById('avg-daily').textContent = '$' + avgDaily;
            document.getElementById('daily-hours').textContent = '4.5h avg/day';
            document.getElementById('projected-total').textContent = '$' + Math.round(totalSpent * 2.5).toLocaleString();
            document.getElementById('remaining-budget').textContent = '$' + (BUDGET_MAX - totalSpent).toLocaleString() + ' remaining';
            
            // Budget bar
            const spentPercent = (totalSpent / BUDGET_MAX) * 100;
            document.getElementById('budget-fill').style.width = spentPercent + '%';
            document.getElementById('budget-projected').style.left = Math.min(spentPercent * 2.5, 100) + '%';
            
            // Projections
            document.getElementById('proj-conservative').textContent = '$95,000';
            document.getElementById('proj-expected').textContent = '$82,500';
            document.getElementById('proj-optimistic').textContent = '$72,000';
            
            // Costs table with sample data
            const tbody = document.getElementById('costs-table');
            let runningTotal = 0;
            const sampleData = [
                { date: '11/26/2025', hours: 4.5, rate: 150, domain: 'Admin' },
                { date: '11/25/2025', hours: 6.0, rate: 150, domain: 'Estate' },
                { date: '11/24/2025', hours: 5.5, rate: 150, domain: 'General' },
                { date: '11/23/2025', hours: 3.0, rate: 150, domain: 'Auth' },
                { date: '11/22/2025', hours: 7.0, rate: 150, domain: 'General' },
            ];
            
            tbody.innerHTML = sampleData.map(s => {
                const cost = s.hours * s.rate;
                runningTotal += cost;
                return `
                    <tr>
                        <td>${s.date}</td>
                        <td>${s.hours}h</td>
                        <td>$${s.rate}/hr</td>
                        <td>$${cost.toLocaleString()}</td>
                        <td>${s.domain}</td>
                        <td>$${runningTotal.toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateStats(totals, breakdown) {
            const totalSpent = totals.totalCost;
            const spentPercent = Math.round((totalSpent / BUDGET_MAX) * 100);
            
            document.getElementById('total-spent').textContent = '$' + totalSpent.toLocaleString();
            document.getElementById('spent-percent').textContent = spentPercent + '% of budget';
            document.getElementById('this-month').textContent = '$' + (breakdown.thisMonth || 0).toLocaleString();
            document.getElementById('avg-daily').textContent = '$' + Math.round(breakdown.avgDaily || 0);
            document.getElementById('projected-total').textContent = '$' + Math.round(breakdown.projectedTotal || 0).toLocaleString();
            document.getElementById('remaining-budget').textContent = '$' + Math.max(0, BUDGET_MAX - totalSpent).toLocaleString() + ' remaining';
            
            // Budget bar
            document.getElementById('budget-fill').style.width = Math.min(spentPercent, 100) + '%';
        }
        
        function renderCostsTable() {
            const tbody = document.getElementById('costs-table');
            
            if (sessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No cost data available</td></tr>';
                return;
            }
            
            let runningTotal = 0;
            tbody.innerHTML = sessions.slice(0, 20).map(s => {
                const date = s.date?.toDate?.() || new Date(s.date);
                const cost = s.hours * (s.rate || HOURLY_RATE);
                runningTotal += cost;
                
                return `
                    <tr>
                        <td>${date.toLocaleDateString()}</td>
                        <td>${s.hours}h</td>
                        <td>$${s.rate || HOURLY_RATE}/hr</td>
                        <td>$${cost.toLocaleString()}</td>
                        <td>${s.agent || 'General'}</td>
                        <td>$${runningTotal.toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }
        
        function initCharts() {
            // Monthly breakdown chart
            const monthlyCtx = document.getElementById('monthlyChart')?.getContext('2d');
            if (monthlyCtx) {
                monthlyChart = new Chart(monthlyCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Sep', 'Oct', 'Nov', 'Dec (Proj)'],
                        datasets: [{
                            label: 'Development Cost',
                            data: [8500, 12400, 16225, 14000],
                            backgroundColor: ['#D4AF37', '#D4AF37', '#D4AF37', 'rgba(212, 175, 55, 0.4)'],
                            borderColor: '#D4AF37',
                            borderWidth: 1,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: value => '$' + (value / 1000) + 'K'
                                }
                            }
                        }
                    }
                });
            }
            
            // Domain breakdown chart
            const domainCtx = document.getElementById('domainChart')?.getContext('2d');
            if (domainCtx) {
                domainChart = new Chart(domainCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Auth', 'Estate', 'Vault', 'Admin', 'General'],
                        datasets: [{
                            data: [4500, 12000, 6500, 8500, 5625],
                            backgroundColor: [
                                '#1e3a8a',
                                '#D4AF37',
                                '#059669',
                                '#0284C7',
                                '#6B7280',
                            ],
                            borderWidth: 0,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: { padding: 12 }
                            }
                        }
                    }
                });
            }
        }
        
        window.updateProjections = function() {
            const range = document.getElementById('projectionRange').value;
            let conservative, expected, optimistic;
            
            const currentSpent = 37125;
            const completion = 0.35;
            
            if (range === 'completion') {
                const remaining = 1 - completion;
                conservative = currentSpent + (currentSpent / completion * remaining * 1.2);
                expected = currentSpent + (currentSpent / completion * remaining * 0.9);
                optimistic = currentSpent + (currentSpent / completion * remaining * 0.7);
            } else {
                const days = parseInt(range);
                const dailyRate = 675;
                conservative = currentSpent + (dailyRate * days * 1.1);
                expected = currentSpent + (dailyRate * days * 0.9);
                optimistic = currentSpent + (dailyRate * days * 0.75);
            }
            
            document.getElementById('proj-conservative').textContent = '$' + Math.round(conservative).toLocaleString();
            document.getElementById('proj-expected').textContent = '$' + Math.round(expected).toLocaleString();
            document.getElementById('proj-optimistic').textContent = '$' + Math.round(optimistic).toLocaleString();
        };
        
        window.exportCosts = function() {
            const csv = [
                ['Date', 'Hours', 'Rate', 'Cost', 'Domain', 'Notes'].join(','),
                ...sessions.map(s => {
                    const date = s.date?.toDate?.() || new Date(s.date);
                    return [
                        date.toLocaleDateString(),
                        s.hours,
                        s.rate || HOURLY_RATE,
                        s.hours * (s.rate || HOURLY_RATE),
                        s.agent || 'General',
                        `"${(s.notes || '').replace(/"/g, '""')}"`
                    ].join(',');
                })
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `development-costs-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            
            showToast('Costs exported', 'success');
        };
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
