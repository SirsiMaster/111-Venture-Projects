<!DOCTYPE html>
<html lang="en" data-auth-protect="admin">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Notifications â€” FinalWishes</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="../finalwishes.css">
    <link rel="stylesheet" href="../assets/css/admin-layout.css">
</head>
<body>
    <div class="admin-wrapper">
        <div id="sidebar-root" data-active="notifications"></div>
        
        <main class="main-content">
            <header id="universal-header-root" 
                    data-title="Notifications & Letters" 
                    data-subtitle="Manage estate notifications, letters, and communications"
                    data-search-placeholder="Search notifications..."></header>
            
            <div class="page-content">
                <!-- Tabs -->
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('all')">All</button>
                    <button class="tab" onclick="switchTab('emails')">Emails</button>
                    <button class="tab" onclick="switchTab('letters')">Letters</button>
                    <button class="tab" onclick="switchTab('sms')">SMS</button>
                    <button class="tab" onclick="switchTab('tasks')">Tasks</button>
                </div>
                
                <!-- Toolbar -->
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn btn-primary" onclick="showCreateModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14"/>
                            </svg>
                            New Notification
                        </button>
                        <div class="filter-group">
                            <select id="statusFilter" class="form-select" onchange="filterNotifications()">
                                <option value="">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="sent">Sent</option>
                                <option value="delivered">Delivered</option>
                                <option value="failed">Failed</option>
                            </select>
                            <select id="estateFilter" class="form-select" onchange="filterNotifications()">
                                <option value="">All Estates</option>
                            </select>
                        </div>
                    </div>
                    <div class="toolbar-right">
                        <button class="btn btn-secondary" onclick="sendBulkNotifications()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                            Send Bulk
                        </button>
                    </div>
                </div>
                
                <!-- Stats Summary -->
                <div class="stats-grid mini">
                    <div class="stat-card mini">
                        <div class="stat-value" id="stat-total">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-card mini">
                        <div class="stat-value" id="stat-pending">0</div>
                        <div class="stat-label">Pending</div>
                    </div>
                    <div class="stat-card mini">
                        <div class="stat-value" id="stat-sent">0</div>
                        <div class="stat-label">Sent</div>
                    </div>
                    <div class="stat-card mini">
                        <div class="stat-value" id="stat-failed">0</div>
                        <div class="stat-label">Failed</div>
                    </div>
                </div>
                
                <!-- Notifications Table -->
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                <th onclick="sortBy('type')">Type <span class="sort-icon">â†•</span></th>
                                <th onclick="sortBy('recipient')">Recipient <span class="sort-icon">â†•</span></th>
                                <th onclick="sortBy('subject')">Subject <span class="sort-icon">â†•</span></th>
                                <th onclick="sortBy('estateName')">Estate <span class="sort-icon">â†•</span></th>
                                <th onclick="sortBy('status')">Status <span class="sort-icon">â†•</span></th>
                                <th onclick="sortBy('scheduledAt')">Scheduled <span class="sort-icon">â†•</span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="notifications-table-body">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: var(--space-xl);">
                                    <div class="skeleton" style="height: 20px; margin-bottom: 8px;"></div>
                                    <div class="skeleton" style="height: 20px; margin-bottom: 8px;"></div>
                                    <div class="skeleton" style="height: 20px;"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="pagination"></div>
            </div>
        </main>
    </div>
    
    <!-- Create/Edit Notification Modal -->
    <div class="modal" id="notificationModal">
        <div class="modal-backdrop" onclick="closeModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">New Notification</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="notificationForm" onsubmit="handleSubmit(event)">
                <div class="modal-body">
                    <div class="form-row two-col">
                        <div class="form-group">
                            <label for="notificationType">Type *</label>
                            <select id="notificationType" name="type" required onchange="updateRecipientField()">
                                <option value="">Select type</option>
                                <option value="email">Email</option>
                                <option value="letter">Physical Letter</option>
                                <option value="sms">SMS</option>
                                <option value="task">Internal Task</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="notificationEstate">Estate *</label>
                            <select id="notificationEstate" name="estateId" required>
                                <option value="">Select estate</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group" id="recipientGroup">
                        <label for="recipient">Recipient *</label>
                        <input type="text" id="recipient" name="recipient" required placeholder="email@example.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="subject">Subject *</label>
                        <input type="text" id="subject" name="subject" required placeholder="Notification subject">
                    </div>
                    
                    <div class="form-group">
                        <label for="body">Message *</label>
                        <textarea id="body" name="body" rows="6" required placeholder="Enter your message..."></textarea>
                    </div>
                    
                    <div class="form-row two-col">
                        <div class="form-group">
                            <label for="template">Use Template</label>
                            <select id="template" name="template" onchange="applyTemplate()">
                                <option value="">No template</option>
                                <option value="heir_notification">Heir Notification</option>
                                <option value="executor_assignment">Executor Assignment</option>
                                <option value="document_request">Document Request</option>
                                <option value="phase_update">Phase Update</option>
                                <option value="deadline_reminder">Deadline Reminder</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="scheduledAt">Schedule For</label>
                            <input type="datetime-local" id="scheduledAt" name="scheduledAt">
                        </div>
                    </div>
                    
                    <div class="form-group" id="letterOptionsGroup" style="display: none;">
                        <h4 class="form-section-title">Letter Options</h4>
                        <div class="form-row two-col">
                            <div class="form-group">
                                <label for="addressLine1">Address Line 1</label>
                                <input type="text" id="addressLine1" name="addressLine1" placeholder="123 Main St">
                            </div>
                            <div class="form-group">
                                <label for="addressLine2">Address Line 2</label>
                                <input type="text" id="addressLine2" name="addressLine2" placeholder="Suite 100">
                            </div>
                        </div>
                        <div class="form-row three-col">
                            <div class="form-group">
                                <label for="city">City</label>
                                <input type="text" id="city" name="city" placeholder="Chicago">
                            </div>
                            <div class="form-group">
                                <label for="state">State</label>
                                <input type="text" id="state" name="state" placeholder="IL">
                            </div>
                            <div class="form-group">
                                <label for="zip">ZIP</label>
                                <input type="text" id="zip" name="zip" placeholder="60601">
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="certifiedMail" name="certifiedMail">
                                Send as Certified Mail (required for legal notices)
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="button" class="btn btn-secondary" onclick="saveDraft()">Save Draft</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">Send Now</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Preview Modal -->
    <div class="modal" id="previewModal">
        <div class="modal-backdrop" onclick="closePreviewModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Notification Preview</h2>
                <button class="modal-close" onclick="closePreviewModal()">&times;</button>
            </div>
            <div class="modal-body" id="previewContent"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closePreviewModal()">Close</button>
                <button type="button" class="btn btn-primary" onclick="resendNotification()">Resend</button>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script src="../components/sidebar.js"></script>
    <script src="../components/universal-header.js"></script>
    
    <script type="module">
        import { DatabaseService } from '../assets/js/firebase-init.js';
        import EstateService from '../assets/js/services/estateService.js';
        
        window.DatabaseService = DatabaseService;
        
        let notifications = [];
        let filteredNotifications = [];
        let estates = [];
        let currentPage = 1;
        let pageSize = 10;
        let sortField = 'createdAt';
        let sortDirection = 'desc';
        let editingId = null;
        let currentTab = 'all';
        let previewingNotification = null;
        
        const templates = {
            heir_notification: {
                subject: 'Notice of Estate Administration - {{estate_name}}',
                body: `Dear {{recipient_name}},

This letter serves as formal notification that you have been identified as a beneficiary of the {{estate_name}} estate.

The estate is currently in the {{phase}} phase of administration. Please contact us at your earliest convenience to discuss your interest in this estate.

Sincerely,
{{executor_name}}
Executor of the {{estate_name}} Estate`
            },
            executor_assignment: {
                subject: 'Executor Assignment - {{estate_name}}',
                body: `Dear {{recipient_name}},

You have been designated as the Executor for the {{estate_name}} estate. This role carries important legal responsibilities.

Please review the estate documentation and contact our office to begin the administration process.

Best regards,
FinalWishes Estate Management`
            },
            document_request: {
                subject: 'Document Request - {{estate_name}}',
                body: `Dear {{recipient_name}},

We require the following documents to proceed with the administration of the {{estate_name}} estate:

- [Document 1]
- [Document 2]

Please upload these documents to your FinalWishes Estate portal or mail copies to our office.

Thank you for your cooperation.`
            },
            phase_update: {
                subject: 'Estate Phase Update - {{estate_name}}',
                body: `Dear {{recipient_name}},

We are pleased to inform you that the {{estate_name}} estate has progressed to the {{phase}} phase.

You can view detailed status updates by logging into your FinalWishes Estate portal.

Best regards,
FinalWishes Estate Management`
            },
            deadline_reminder: {
                subject: 'Important Deadline Reminder - {{estate_name}}',
                body: `Dear {{recipient_name}},

This is a reminder that the following deadline is approaching for the {{estate_name}} estate:

Deadline: {{deadline_date}}
Action Required: {{action_required}}

Please ensure all necessary actions are completed before this date.

Thank you.`
            }
        };
        
        async function init() {
            console.log('ðŸ›ï¸ FinalWishes - Notifications');
            await loadEstates();
            await loadNotifications();
        }
        
        async function loadEstates() {
            try {
                estates = await EstateService.getAllEstates();
                const selects = ['estateFilter', 'notificationEstate'];
                selects.forEach(id => {
                    const select = document.getElementById(id);
                    const defaultOption = id === 'estateFilter' ? '<option value="">All Estates</option>' : '<option value="">Select estate</option>';
                    select.innerHTML = defaultOption + estates.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
                });
            } catch (error) {
                console.error('Error loading estates:', error);
            }
        }
        
        async function loadNotifications() {
            try {
                notifications = await DatabaseService.getDocuments('notifications');
                filteredNotifications = [...notifications];
                updateStats();
                renderNotifications();
            } catch (error) {
                console.error('Error loading notifications:', error);
                showToast('Failed to load notifications', 'error');
            }
        }
        
        function updateStats() {
            document.getElementById('stat-total').textContent = notifications.length;
            document.getElementById('stat-pending').textContent = notifications.filter(n => n.status === 'pending').length;
            document.getElementById('stat-sent').textContent = notifications.filter(n => n.status === 'sent' || n.status === 'delivered').length;
            document.getElementById('stat-failed').textContent = notifications.filter(n => n.status === 'failed').length;
        }
        
        function renderNotifications() {
            const tbody = document.getElementById('notifications-table-body');
            const start = (currentPage - 1) * pageSize;
            const pageNotifications = filteredNotifications.slice(start, start + pageSize);
            
            if (pageNotifications.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: var(--space-xl);">
                            <div style="color: var(--text-secondary);">No notifications found.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = pageNotifications.map(n => {
                const estate = estates.find(e => e.id === n.estateId);
                const scheduledAt = n.scheduledAt?.toDate?.() || (n.scheduledAt ? new Date(n.scheduledAt) : null);
                const dateStr = scheduledAt ? scheduledAt.toLocaleString() : 'Immediate';
                const statusClass = getStatusClass(n.status);
                const typeIcon = getTypeIcon(n.type);
                
                return `
                    <tr>
                        <td><input type="checkbox" class="notification-checkbox" data-id="${n.id}"></td>
                        <td>${typeIcon} ${capitalize(n.type)}</td>
                        <td>${n.recipient || 'N/A'}</td>
                        <td>${n.subject || 'No subject'}</td>
                        <td>${estate?.name || 'â€”'}</td>
                        <td><span class="badge ${statusClass}">${capitalize(n.status || 'pending')}</span></td>
                        <td>${dateStr}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-icon btn-sm" onclick="previewNotification('${n.id}')" title="Preview">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                        <circle cx="12" cy="12" r="3"></circle>
                                    </svg>
                                </button>
                                ${n.status === 'pending' ? `
                                    <button class="btn btn-icon btn-sm" onclick="sendNow('${n.id}')" title="Send Now">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="22" y1="2" x2="11" y2="13"></line>
                                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                        </svg>
                                    </button>
                                ` : ''}
                                <button class="btn btn-icon btn-sm btn-danger" onclick="deleteNotification('${n.id}')" title="Delete">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            renderPagination();
        }
        
        function renderPagination() {
            const totalPages = Math.ceil(filteredNotifications.length / pageSize);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            pagination.innerHTML = `
                <button class="btn btn-sm btn-secondary" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">Previous</button>
                <span class="pagination-info">Page ${currentPage} of ${totalPages}</span>
                <button class="btn btn-sm btn-secondary" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">Next</button>
            `;
        }
        
        // Tab switching
        window.switchTab = function(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            if (tab === 'all') {
                filteredNotifications = [...notifications];
            } else if (tab === 'tasks') {
                filteredNotifications = notifications.filter(n => n.type === 'task');
            } else {
                filteredNotifications = notifications.filter(n => n.type === tab.replace(/s$/, '')); // emails -> email
            }
            
            currentPage = 1;
            renderNotifications();
        };
        
        // Filter and sort
        window.filterNotifications = function() {
            const status = document.getElementById('statusFilter').value;
            const estateId = document.getElementById('estateFilter').value;
            
            let filtered = [...notifications];
            
            if (currentTab !== 'all') {
                const type = currentTab === 'tasks' ? 'task' : currentTab.replace(/s$/, '');
                filtered = filtered.filter(n => n.type === type);
            }
            
            if (status) filtered = filtered.filter(n => n.status === status);
            if (estateId) filtered = filtered.filter(n => n.estateId === estateId);
            
            filteredNotifications = filtered;
            currentPage = 1;
            renderNotifications();
        };
        
        window.sortBy = function(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }
            
            filteredNotifications.sort((a, b) => {
                const aVal = a[field] || '';
                const bVal = b[field] || '';
                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            renderNotifications();
        };
        
        window.goToPage = function(page) {
            currentPage = page;
            renderNotifications();
        };
        
        window.toggleSelectAll = function() {
            const checked = document.getElementById('selectAll').checked;
            document.querySelectorAll('.notification-checkbox').forEach(cb => cb.checked = checked);
        };
        
        // Modal functions
        window.showCreateModal = function() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'New Notification';
            document.getElementById('submitBtn').textContent = 'Send Now';
            document.getElementById('notificationForm').reset();
            document.getElementById('letterOptionsGroup').style.display = 'none';
            document.getElementById('notificationModal').classList.add('open');
        };
        
        window.closeModal = function() {
            document.getElementById('notificationModal').classList.remove('open');
            editingId = null;
        };
        
        window.updateRecipientField = function() {
            const type = document.getElementById('notificationType').value;
            const recipientInput = document.getElementById('recipient');
            const letterOptions = document.getElementById('letterOptionsGroup');
            
            letterOptions.style.display = type === 'letter' ? 'block' : 'none';
            
            switch (type) {
                case 'email':
                    recipientInput.placeholder = 'email@example.com';
                    recipientInput.type = 'email';
                    break;
                case 'sms':
                    recipientInput.placeholder = '(555) 123-4567';
                    recipientInput.type = 'tel';
                    break;
                case 'letter':
                    recipientInput.placeholder = 'Recipient Name';
                    recipientInput.type = 'text';
                    break;
                case 'task':
                    recipientInput.placeholder = 'Assignee name or email';
                    recipientInput.type = 'text';
                    break;
            }
        };
        
        window.applyTemplate = function() {
            const templateKey = document.getElementById('template').value;
            if (!templateKey || !templates[templateKey]) return;
            
            const template = templates[templateKey];
            document.getElementById('subject').value = template.subject;
            document.getElementById('body').value = template.body;
        };
        
        window.handleSubmit = async function(e) {
            e.preventDefault();
            
            const form = e.target;
            const data = {
                type: form.type.value,
                estateId: form.estateId.value,
                recipient: form.recipient.value,
                subject: form.subject.value,
                body: form.body.value,
                status: 'pending',
                createdAt: new Date(),
            };
            
            if (form.scheduledAt.value) {
                data.scheduledAt = new Date(form.scheduledAt.value);
            }
            
            if (form.type.value === 'letter') {
                data.address = {
                    line1: form.addressLine1.value,
                    line2: form.addressLine2.value,
                    city: form.city.value,
                    state: form.state.value,
                    zip: form.zip.value,
                };
                data.certifiedMail = form.certifiedMail.checked;
            }
            
            try {
                if (editingId) {
                    await DatabaseService.updateDocument('notifications', editingId, data);
                    showToast('Notification updated', 'success');
                } else {
                    await DatabaseService.createDocument('notifications', data);
                    showToast('Notification created', 'success');
                }
                
                closeModal();
                await loadNotifications();
            } catch (error) {
                console.error('Error saving notification:', error);
                showToast('Failed to save notification', 'error');
            }
        };
        
        window.saveDraft = async function() {
            const form = document.getElementById('notificationForm');
            const data = {
                type: form.type.value,
                estateId: form.estateId.value,
                recipient: form.recipient.value,
                subject: form.subject.value,
                body: form.body.value,
                status: 'draft',
                createdAt: new Date(),
            };
            
            try {
                await DatabaseService.createDocument('notifications', data);
                showToast('Draft saved', 'success');
                closeModal();
                await loadNotifications();
            } catch (error) {
                console.error('Error saving draft:', error);
                showToast('Failed to save draft', 'error');
            }
        };
        
        window.sendNow = async function(id) {
            try {
                await DatabaseService.updateDocument('notifications', id, {
                    status: 'sent',
                    sentAt: new Date()
                });
                showToast('Notification sent', 'success');
                await loadNotifications();
            } catch (error) {
                console.error('Error sending:', error);
                showToast('Failed to send notification', 'error');
            }
        };
        
        window.previewNotification = function(id) {
            previewingNotification = notifications.find(n => n.id === id);
            if (!previewingNotification) return;
            
            const n = previewingNotification;
            const estate = estates.find(e => e.id === n.estateId);
            
            document.getElementById('previewContent').innerHTML = `
                <div class="preview-details">
                    <div class="preview-row"><strong>Type:</strong> ${capitalize(n.type)}</div>
                    <div class="preview-row"><strong>Recipient:</strong> ${n.recipient}</div>
                    <div class="preview-row"><strong>Estate:</strong> ${estate?.name || 'N/A'}</div>
                    <div class="preview-row"><strong>Status:</strong> <span class="badge ${getStatusClass(n.status)}">${capitalize(n.status)}</span></div>
                </div>
                <hr>
                <div class="preview-subject"><strong>Subject:</strong> ${n.subject}</div>
                <div class="preview-body">${n.body?.replace(/\n/g, '<br>') || 'No content'}</div>
            `;
            
            document.getElementById('previewModal').classList.add('open');
        };
        
        window.closePreviewModal = function() {
            document.getElementById('previewModal').classList.remove('open');
            previewingNotification = null;
        };
        
        window.resendNotification = async function() {
            if (!previewingNotification) return;
            
            try {
                await DatabaseService.updateDocument('notifications', previewingNotification.id, {
                    status: 'pending',
                    scheduledAt: new Date()
                });
                showToast('Notification queued for resend', 'success');
                closePreviewModal();
                await loadNotifications();
            } catch (error) {
                console.error('Error resending:', error);
                showToast('Failed to resend notification', 'error');
            }
        };
        
        window.deleteNotification = async function(id) {
            if (!confirm('Are you sure you want to delete this notification?')) return;
            
            try {
                await DatabaseService.deleteDocument('notifications', id);
                showToast('Notification deleted', 'success');
                await loadNotifications();
            } catch (error) {
                console.error('Error deleting:', error);
                showToast('Failed to delete notification', 'error');
            }
        };
        
        window.sendBulkNotifications = async function() {
            const selected = Array.from(document.querySelectorAll('.notification-checkbox:checked')).map(cb => cb.dataset.id);
            if (selected.length === 0) {
                showToast('No notifications selected', 'warning');
                return;
            }
            
            if (!confirm(`Send ${selected.length} notification(s)?`)) return;
            
            try {
                for (const id of selected) {
                    await DatabaseService.updateDocument('notifications', id, {
                        status: 'sent',
                        sentAt: new Date()
                    });
                }
                showToast(`${selected.length} notification(s) sent`, 'success');
                await loadNotifications();
            } catch (error) {
                console.error('Error bulk sending:', error);
                showToast('Failed to send notifications', 'error');
            }
        };
        
        // Utility functions
        function capitalize(str) {
            return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
        }
        
        function getStatusClass(status) {
            const map = {
                pending: 'badge-warning',
                sent: 'badge-info',
                delivered: 'badge-success',
                failed: 'badge-danger',
                draft: 'badge-neutral'
            };
            return map[status] || 'badge-neutral';
        }
        
        function getTypeIcon(type) {
            const icons = {
                email: 'âœ‰ï¸',
                letter: 'ðŸ“®',
                sms: 'ðŸ’¬',
                task: 'ðŸ“‹'
            };
            return icons[type] || 'ðŸ“¨';
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
