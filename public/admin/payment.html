<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Payment | Sirsi Technologies</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Dependencies -->
    <link href="../assets/css/tailwind.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <link href="../assets/css/admin-layout.css" rel="stylesheet">

    <!-- Firebase SDK (Modular) -->
    <script type="module">
        import { AuthService } from '../assets/js/firebase-init.js';
        window.AuthService = AuthService;
    </script>

    <script>
        // Frame Breaker: Ensure we are not stuck inside sign.html iframe
        if (window.top !== window.self) {
            window.top.location = window.self.location;
        }
    </script>

    <style>
        /* Immersive Background */
        body {
            background: radial-gradient(circle at 50% 0%, #1e293b 0%, #0f172a 100%);
            min-height: 100vh;
            color: white;
            font-family: 'Inter', sans-serif;
        }

        .gold-glow {
            text-shadow: 0 0 20px rgba(200, 169, 81, 0.4);
        }

        .glass-panel {
            background: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .payment-option-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .payment-option-card:hover {
            transform: translateY(-4px);
            border-color: rgba(200, 169, 81, 0.4);
            background: rgba(255, 255, 255, 0.03);
        }

        /* Checkmark Animation */
        @keyframes scaleIn {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .animate-scale-in {
            animation: scaleIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
    </style>
</head>

<body class="flex flex-col min-h-screen">

    <!-- Navbar Minimal -->
    <nav class="border-b border-white/5 bg-[#0f172a]/80 backdrop-blur-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-gradient-to-br from-[#C8A951] to-[#8A7130] rounded-sm transform rotate-45"></div>
                <span class="font-serif font-bold text-xl tracking-widest text-[#C8A951]">SIRSI</span>
            </div>
            <div class="flex items-center gap-2 text-xs font-mono text-gray-500">
                <div class="w-2 h-2 rounded-full bg-[#10B981] animate-pulse"></div>
                SECURE TERMINAL
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-grow flex items-center justify-center p-6 relative overflow-hidden">
        <!-- Background Decor -->
        <div
            class="absolute top-0 left-1/2 -translate-x-1/2 w-[800px] h-[500px] bg-[#C8A951] opacity-[0.03] blur-[120px] rounded-full pointer-events-none">
        </div>

        <div class="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-12 gap-8 relative z-10">

            <!-- LEFT COLUMN: Payment Selection -->
            <div class="lg:col-span-7 space-y-6">
                <div class="mb-8">
                    <h1 class="font-serif text-3xl md:text-4xl text-white mb-2">Secure Payment</h1>
                    <p class="text-gray-400">Select your preferred method to complete the transaction.</p>
                </div>

                <!-- Stripe Option -->
                <div class="glass-panel rounded-2xl p-1 overflow-hidden payment-option-card group cursor-pointer"
                    onclick="selectPayment('stripe')">
                    <div class="p-6 relative">
                        <!-- Selection Indicator -->
                        <div
                            class="absolute top-6 right-6 w-6 h-6 rounded-full border border-white/20 group-hover:border-[#635BFF] flex items-center justify-center transition-colors">
                            <div class="w-3 h-3 bg-[#635BFF] rounded-full opacity-0 group-[.selected]:opacity-100 transition-opacity"
                                id="indicator-stripe"></div>
                        </div>

                        <div class="flex items-start gap-5">
                            <div
                                class="w-14 h-14 rounded-xl bg-[#635BFF] flex items-center justify-center shadow-lg shadow-[#635BFF]/20 text-white">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="2" y="5" width="20" height="14" rx="2"></rect>
                                    <line x1="2" y1="10" x2="22" y2="10"></line>
                                </svg>
                            </div>
                            <div>
                                <h3
                                    class="text-xl font-bold text-white mb-1 group-hover:text-[#635BFF] transition-colors">
                                    Credit Card / ACH</h3>
                                <p class="text-sm text-gray-400 mb-3">Instant processing via Stripe Secure Checkout.</p>
                                <div class="flex gap-2">
                                    <span
                                        class="px-2 py-1 rounded bg-white/5 border border-white/5 text-[10px] text-gray-400">VISA</span>
                                    <span
                                        class="px-2 py-1 rounded bg-white/5 border border-white/5 text-[10px] text-gray-400">MC</span>
                                    <span
                                        class="px-2 py-1 rounded bg-white/5 border border-white/5 text-[10px] text-gray-400">AMEX</span>
                                </div>
                            </div>
                        </div>

                        <!-- Expanded Content (Hidden by default) -->
                        <div id="content-stripe" class="hidden mt-6 pt-6 border-t border-white/10 animate-fade-in">
                            <button onclick="handleStripeRedirect()"
                                class="w-full py-4 rounded-xl bg-[#635BFF] hover:bg-[#5349E0] text-white font-bold tracking-wide shadow-xl shadow-[#635BFF]/20 transition-all flex items-center justify-center gap-3">
                                <span>Proceed to Secure Checkout</span>
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                    <polyline points="15 3 21 3 21 9"></polyline>
                                    <line x1="10" y1="14" x2="21" y2="3"></line>
                                </svg>
                            </button>
                            <div class="mt-4 flex items-center justify-center gap-2 text-xs text-gray-500">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                </svg>
                                SSL Encrypted Transaction
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chase Option -->
                <div class="glass-panel rounded-2xl p-1 overflow-hidden payment-option-card group cursor-pointer"
                    onclick="selectPayment('chase')">
                    <div class="p-6 relative">
                        <!-- Selection Indicator -->
                        <div
                            class="absolute top-6 right-6 w-6 h-6 rounded-full border border-white/20 group-hover:border-[#117ACA] flex items-center justify-center transition-colors">
                            <div class="w-3 h-3 bg-[#117ACA] rounded-full opacity-0 group-[.selected]:opacity-100 transition-opacity"
                                id="indicator-chase"></div>
                        </div>

                        <div class="flex items-start gap-5">
                            <div
                                class="w-14 h-14 rounded-xl bg-[#117ACA] flex items-center justify-center shadow-lg shadow-[#117ACA]/20 text-white">
                                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                                    <polyline points="2 17 12 22 22 17"></polyline>
                                    <polyline points="2 12 12 17 22 12"></polyline>
                                </svg>
                            </div>
                            <div>
                                <h3
                                    class="text-xl font-bold text-white mb-1 group-hover:text-[#117ACA] transition-colors">
                                    Wire Transfer</h3>
                                <p class="text-sm text-gray-400 mb-3">Direct corporate wire to Chase Commercial.</p>
                                <div class="flex gap-2">
                                    <span
                                        class="px-2 py-1 rounded bg-[#117ACA]/10 border border-[#117ACA]/20 text-[10px] text-[#117ACA]">COMMERCIAL</span>
                                    <span
                                        class="px-2 py-1 rounded bg-white/5 border border-white/5 text-[10px] text-gray-400">NET
                                        15</span>
                                </div>
                            </div>
                        </div>

                        <!-- Expanded Content (Hidden by default) -->
                        <div id="content-chase" class="hidden mt-6 pt-6 border-t border-white/10 animate-fade-in">
                            <div
                                class="bg-black/40 rounded-lg p-5 border border-white/10 mb-5 relative overflow-hidden">
                                <div
                                    class="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/carbon-fibre.png')] opacity-20">
                                </div>
                                <div class="relative z-10 grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <div class="text-[10px] uppercase text-gray-500 tracking-wider mb-1">Bank Name
                                        </div>
                                        <div class="font-semibold text-white">JPMORGAN CHASE BANK, N.A. (001)</div>
                                    </div>
                                    <div>
                                        <div class="text-[10px] uppercase text-gray-500 tracking-wider mb-1">Beneficiary
                                        </div>
                                        <div class="font-semibold text-white">Sirsi Technologies Inc</div>
                                    </div>
                                    <div>
                                        <div class="text-[10px] uppercase text-gray-500 tracking-wider mb-1">Routing
                                            (Wire)</div>
                                        <div class="font-mono text-[#117ACA]">021000021</div>
                                    </div>
                                    <div>
                                        <div class="text-[10px] uppercase text-gray-500 tracking-wider mb-1">Account
                                            Number</div>
                                        <div class="font-mono text-white">2905276162</div>
                                    </div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <button onclick="generatePDF()"
                                    class="w-full py-3 rounded-xl bg-white/10 hover:bg-white/20 text-white font-semibold border border-white/10 transition-all flex items-center justify-center gap-2">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                        <polyline points="7 10 12 15 17 10"></polyline>
                                        <line x1="12" y1="15" x2="12" y2="3"></line>
                                    </svg>
                                    <span>Download Invoice</span>
                                </button>
                                <button onclick="window.open('https://www.chase.com/business/online-banking', '_blank')"
                                    class="w-full py-3 rounded-xl bg-[#117ACA] hover:bg-[#0D62A5] text-white font-semibold transition-all flex items-center justify-center gap-2">
                                    <span>Log in to Chase</span>
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                                        <polyline points="15 3 21 3 21 9"></polyline>
                                        <line x1="10" y1="14" x2="21" y2="3"></line>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Invoice Summary -->
            <div class="lg:col-span-5">
                <div class="sticky top-24 glass-panel rounded-2xl border-t-4 border-t-[#C8A951]">
                    <div class="p-8">
                        <div class="flex justify-center mb-6">
                            <div
                                class="w-20 h-20 rounded-full bg-[#10B981]/10 border border-[#10B981]/30 flex items-center justify-center animate-scale-in">
                                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#10B981"
                                    stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                                    <polyline points="20 6 9 17 4 12"></polyline>
                                </svg>
                            </div>
                        </div>

                        <div class="text-center mb-8 border-b border-white/10 pb-8">
                            <h2 class="text-2xl font-serif text-white mb-1">Agreement Signed</h2>
                            <p class="text-sm text-gray-400">MSA Reference: <span id="ref-display"
                                    class="text-white font-mono">LOADING...</span></p>
                        </div>

                        <div class="space-y-4 mb-8">
                            <div class="flex justify-between items-end">
                                <span class="text-sm text-gray-400 uppercase tracking-wider">Total Due Now</span>
                                <span id="amount-display-main"
                                    class="text-3xl font-serif text-[#C8A951] gold-glow">$0.00</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-500">Service Fee</span>
                                <span class="text-gray-400">Included</span>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-500">Processing</span>
                                <span class="text-gray-400">Waived</span>
                            </div>
                        </div>

                        <div class="bg-white/5 rounded-lg p-4 text-xs text-gray-400 leading-relaxed text-center">
                            By proceeding, you agree to the Terms of Service and authorize the transaction for the
                            stated amount.
                        </div>
                    </div>
                    <div class="bg-white/5 p-4 text-center ">
                        <a href="dashboard.html"
                            class="text-xs text-[#C8A951] hover:underline uppercase tracking-widest">Skip & Return to
                            Dashboard</a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- HIDDEN INVOICE TEMPLATE (For PDF Generation) -->
    <div id="invoice-template" class="hidden bg-white text-black p-12 max-w-[800px] mx-auto">
        <!-- Will be populated by JS -->
    </div>

    <script>
        // --- 1. CORE LOGIC ---
        const urlParams = new URLSearchParams(window.location.search);
        const amount = urlParams.get('amount') || '175000'; // Default backup
        const ref = urlParams.get('ref') || 'MSA-Unknown';

        // Format Currency
        const formatter = new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: 0
        });

        // Init UI
        document.getElementById('amount-display-main').textContent = formatter.format(amount);
        document.getElementById('ref-display').textContent = ref;

        // --- 2. PAYMENT SELECTION UI ---
        function selectPayment(method) {
            // Reset all
            document.querySelectorAll('.payment-option-card').forEach(el => {
                el.classList.remove('border-[#635BFF]', 'border-[#117ACA]', 'bg-white/5', 'selected');
                el.style.borderColor = 'rgba(255, 255, 255, 0.08)';
            });
            document.getElementById('indicator-stripe').parentElement.classList.remove('bg-[#635BFF]');
            document.getElementById('indicator-chase').parentElement.classList.remove('bg-[#117ACA]');

            // Hide contents
            document.getElementById('content-stripe').classList.add('hidden');
            document.getElementById('content-chase').classList.add('hidden');
            document.getElementById('indicator-stripe').style.opacity = '0';
            document.getElementById('indicator-chase').style.opacity = '0';

            // Activate Selected
            const activeCard = document.querySelector(`[onclick="selectPayment('${method}')"]`);
            activeCard.classList.add('selected');

            if (method === 'stripe') {
                activeCard.style.borderColor = '#635BFF';
                activeCard.style.backgroundColor = 'rgba(99, 91, 255, 0.05)';
                document.getElementById('content-stripe').classList.remove('hidden');
                document.getElementById('indicator-stripe').style.opacity = '1';
                document.getElementById('indicator-stripe').parentElement.style.borderColor = '#635BFF';
            } else {
                activeCard.style.borderColor = '#117ACA';
                activeCard.style.backgroundColor = 'rgba(17, 122, 202, 0.05)';
                document.getElementById('content-chase').classList.remove('hidden');
                document.getElementById('indicator-chase').style.opacity = '1';
                document.getElementById('indicator-chase').parentElement.style.borderColor = '#117ACA';
            }
        }

        // --- 3. ACTIONS ---
        function handleStripeRedirect() {
            // Configuration: Map Amounts to Stripe Payment Links
            // UPDATED: 2025-12-23 (Live Test Links)
            const STRIPE_LINKS = {
                '100000': 'https://buy.stripe.com/test_fZu4gz17k7WO9sx3Mgfw400',   // Plan A (Milestone)
                '66666.66': 'https://buy.stripe.com/test_3cI00j6rE5OGgUZdmQfw401', // Plan B (Trimester)
                '75000': 'https://buy.stripe.com/test_8x28wP3fs4KCdIN82wfw402',    // Plan C (Bundle)
                '175000': 'https://buy.stripe.com/test_fZu4gz17k7WO9sx3Mgfw400'    // Fallback
            };

            // Fuzzy match amount (remove decimals/formatting) to find key
            // We use the raw 'amount' string from URL params
            let targetUrl = STRIPE_LINKS[amount];

            // If exact match fails, try simple fallback logic
            if (!targetUrl) {
                if (amount.startsWith('100000')) targetUrl = STRIPE_LINKS['100000'];
                else if (amount.startsWith('66')) targetUrl = STRIPE_LINKS['66666.66'];
                else if (amount.startsWith('75')) targetUrl = STRIPE_LINKS['75000'];
                else targetUrl = STRIPE_LINKS['175000'];
            }

            // Append tracking
            const finalUrl = `${targetUrl}?prefilled_email=client@example.com&client_reference_id=${ref}`;
            window.open(finalUrl, '_blank');
        }

        function generatePDF() {
            // 1. Populate Template
            const template = document.createElement('div');
            template.innerHTML = getInvoiceTemplateHTML();

            const opt = {
                margin: 0.5,
                filename: `Invoice_${ref}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            html2pdf().set(opt).from(template).save();
        }

        async function emailReceipt() {
            const user = firebase.auth().currentUser;
            if (!user || !user.email) {
                console.warn('User not logged in, cannot email receipt automatically.');
                return;
            }

            const btn = document.getElementById('email-receipt-btn');
            if (btn) btn.innerHTML = 'Sending...';

            try {
                // 1. Generate PDF Base64
                // Re-use logic from generatePDF but get output
                const template = document.createElement('div');
                template.innerHTML = getInvoiceTemplateHTML(); // Extracted helper

                const opt = {
                    margin: 0.5,
                    filename: `Invoice_${ref}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
                };

                // html2pdf output to base64
                const pdfBase64 = await html2pdf().set(opt).from(template).outputPdf('datauristring').then(d => d.split(',')[1]);

                // 2. Send via Firebase Function
                const sendContractEmail = firebase.functions().httpsCallable('sendContractEmail');
                await sendContractEmail({
                    email: user.email,
                    pdfBase64: pdfBase64,
                    documentType: 'Payment Receipt'
                });

                console.log('✅ Receipt emailed successfully.');
                if (btn) btn.innerHTML = '✓ Receipt Emailed';

            } catch (err) {
                console.error('Email Receipt Error:', err);
                if (btn) btn.innerHTML = 'Email Failed';
            }
        }

        function getInvoiceTemplateHTML() {
            return `
                <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; color: #333; padding: 40px;">
                    <div style="display: flex; justify-content: space-between; border-bottom: 2px solid #C8A951; padding-bottom: 20px; margin-bottom: 30px;">
                        <div>
                            <h1 style="margin: 0; color: #000; font-size: 28px;">INVOICE</h1>
                            <p style="margin: 5px 0 0; color: #666;">Reference: ${ref}</p>
                        </div>
                        <div style="text-align: right;">
                            <h2 style="margin: 0; color: #C8A951;">SIRSI TECHNOLOGIES</h2>
                            <p style="margin: 5px 0 0; font-size: 12px; color: #666;">111 Venture Studio<br>New York, NY</p>
                        </div>
                    </div>

                    <div style="margin-bottom: 40px;">
                        <p><strong>Bill To:</strong><br>Client (Pending Execution)<br>FinalWishes Project</p>
                    </div>

                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                        <thead style="background: #f9f9f9;">
                            <tr>
                                <th style="padding: 12px; text-align: left; border-bottom: 1px solid #eee;">Description</th>
                                <th style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 12px; border-bottom: 1px solid #eee;">
                                    <strong>Initial Milestone Payment</strong><br>
                                    <span style="font-size: 12px; color: #666;">Master Services Agreement Execution - Payment 1 of 3</span>
                                </td>
                                <td style="padding: 12px; text-align: right; border-bottom: 1px solid #eee;">
                                    ${formatter.format(amount)}
                                </td>
                            </tr>
                        </tbody>
                    </table>

                    <div style="text-align: right; margin-bottom: 40px;">
                        <p style="font-size: 18px;"><strong>Total Due: ${formatter.format(amount)}</strong></p>
                    </div>

                    <div style="background: #f0f7ff; border: 1px solid #cce5ff; padding: 20px; border-radius: 4px;">
                        <h3 style="margin: 0 0 10px; color: #117ACA; font-size: 14px;">WIRE TRANSFER INSTRUCTIONS</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; font-size: 12px; gap: 10px;">
                            <div><strong>Bank:</strong> JPMORGAN CHASE BANK, N.A. (001)</div>
                            <div><strong>Beneficiary:</strong> Sirsi Technologies Inc</div>
                            <div><strong>Routing:</strong> 021000021</div>
                            <div><strong>Account:</strong> 2905276162</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Auto-select Stripe by default
        selectPayment('stripe');

        // Check Auth and Auto-Email
        document.addEventListener('DOMContentLoaded', () => {
            // Wait for Auth to init
            setTimeout(() => {
                const user = firebase.auth().currentUser;
                if (user) {
                    console.log('User detected, attempting auto-receipt email...');
                    emailReceipt();
                }
            }, 2000);
        });
    </script>
</body>

</html>