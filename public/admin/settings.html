<!DOCTYPE html>
<html lang="en" data-auth-protect="admin">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Settings â€” MyShepherd</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="../legacy.css">
    <link rel="stylesheet" href="../assets/css/admin-layout.css">
</head>
<body>
    <div class="admin-wrapper">
        <div id="sidebar-root" data-active="settings"></div>
        
        <main class="main-content">
            <header id="universal-header-root" 
                    data-title="System Settings" 
                    data-subtitle="Configure platform settings and preferences"
                    data-search-placeholder="Search settings..."></header>
            
            <div class="page-content">
                <!-- Settings Navigation -->
                <div class="settings-layout">
                    <nav class="settings-nav">
                        <a href="#general" class="settings-nav-item active" onclick="showSection('general')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33"></path>
                            </svg>
                            General
                        </a>
                        <a href="#security" class="settings-nav-item" onclick="showSection('security')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                            </svg>
                            Security
                        </a>
                        <a href="#notifications" class="settings-nav-item" onclick="showSection('notifications')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 17H2a3 3 0 0 0 3-3V9a7 7 0 0 1 14 0v5a3 3 0 0 0 3 3zm-8.27 4a2 2 0 0 1-3.46 0"></path>
                            </svg>
                            Notifications
                        </a>
                        <a href="#integrations" class="settings-nav-item" onclick="showSection('integrations')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="16 18 22 12 16 6"></polyline>
                                <polyline points="8 6 2 12 8 18"></polyline>
                            </svg>
                            Integrations
                        </a>
                        <a href="#billing" class="settings-nav-item" onclick="showSection('billing')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                            Billing
                        </a>
                        <a href="#compliance" class="settings-nav-item" onclick="showSection('compliance')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            Compliance
                        </a>
                        <a href="#advanced" class="settings-nav-item" onclick="showSection('advanced')">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="4" y1="21" x2="4" y2="14"></line>
                                <line x1="4" y1="10" x2="4" y2="3"></line>
                                <line x1="12" y1="21" x2="12" y2="12"></line>
                                <line x1="12" y1="8" x2="12" y2="3"></line>
                                <line x1="20" y1="21" x2="20" y2="16"></line>
                                <line x1="20" y1="12" x2="20" y2="3"></line>
                            </svg>
                            Advanced
                        </a>
                    </nav>
                    
                    <div class="settings-content">
                        <!-- General Settings -->
                        <section id="general" class="settings-section active">
                            <h2>General Settings</h2>
                            <p class="section-description">Configure basic platform settings and appearance.</p>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Organization Details</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-row two-col">
                                        <div class="form-group">
                                            <label for="orgName">Organization Name</label>
                                            <input type="text" id="orgName" name="orgName" value="MyShepherd Estate Management" placeholder="Your organization name">
                                        </div>
                                        <div class="form-group">
                                            <label for="contactEmail">Contact Email</label>
                                            <input type="email" id="contactEmail" name="contactEmail" value="contact@legacyestate.io" placeholder="Primary contact email">
                                        </div>
                                    </div>
                                    <div class="form-row two-col">
                                        <div class="form-group">
                                            <label for="timezone">Default Timezone</label>
                                            <select id="timezone" name="timezone">
                                                <option value="America/Chicago" selected>Central Time (CT)</option>
                                                <option value="America/New_York">Eastern Time (ET)</option>
                                                <option value="America/Denver">Mountain Time (MT)</option>
                                                <option value="America/Los_Angeles">Pacific Time (PT)</option>
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="dateFormat">Date Format</label>
                                            <select id="dateFormat" name="dateFormat">
                                                <option value="MM/DD/YYYY" selected>MM/DD/YYYY</option>
                                                <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                                <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Appearance</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label>Theme</label>
                                        <div class="radio-group">
                                            <label class="radio-label">
                                                <input type="radio" name="theme" value="dark" checked> Dark (Default)
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="theme" value="light"> Light
                                            </label>
                                            <label class="radio-label">
                                                <input type="radio" name="theme" value="system"> System
                                            </label>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="compactMode" name="compactMode">
                                            Enable compact mode (reduces spacing)
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </section>
                        
                        <!-- Security Settings -->
                        <section id="security" class="settings-section">
                            <h2>Security Settings</h2>
                            <p class="section-description">Manage authentication, access control, and security policies.</p>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Authentication</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="mfaRequired" name="mfaRequired" checked>
                                            Require Multi-Factor Authentication (MFA) for all admin users
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="mfaExecutors" name="mfaExecutors">
                                            Require MFA for Executors
                                        </label>
                                    </div>
                                    <div class="form-row two-col">
                                        <div class="form-group">
                                            <label for="sessionTimeout">Session Timeout (minutes)</label>
                                            <input type="number" id="sessionTimeout" name="sessionTimeout" value="60" min="15" max="480">
                                        </div>
                                        <div class="form-group">
                                            <label for="maxLoginAttempts">Max Login Attempts</label>
                                            <input type="number" id="maxLoginAttempts" name="maxLoginAttempts" value="5" min="3" max="10">
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Password Policy</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-row two-col">
                                        <div class="form-group">
                                            <label for="minPasswordLength">Minimum Password Length</label>
                                            <input type="number" id="minPasswordLength" name="minPasswordLength" value="12" min="8" max="32">
                                        </div>
                                        <div class="form-group">
                                            <label for="passwordExpiry">Password Expiry (days)</label>
                                            <input type="number" id="passwordExpiry" name="passwordExpiry" value="90" min="30" max="365">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="requireSpecialChars" name="requireSpecialChars" checked>
                                            Require special characters
                                        </label>
                                    </div>
                                    <div class="form-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="requireUpperLower" name="requireUpperLower" checked>
                                            Require uppercase and lowercase letters
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </section>
                        
                        <!-- Notification Settings -->
                        <section id="notifications" class="settings-section">
                            <h2>Notification Settings</h2>
                            <p class="section-description">Configure email, SMS, and letter notification preferences.</p>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Email Configuration</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-row two-col">
                                        <div class="form-group">
                                            <label for="emailFromName">From Name</label>
                                            <input type="text" id="emailFromName" name="emailFromName" value="MyShepherd">
                                        </div>
                                        <div class="form-group">
                                            <label for="emailFromAddress">From Email</label>
                                            <input type="email" id="emailFromAddress" name="emailFromAddress" value="noreply@legacyestate.io">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label for="emailProvider">Email Provider</label>
                                        <select id="emailProvider" name="emailProvider">
                                            <option value="firebase" selected>Firebase (SendGrid)</option>
                                            <option value="ses">Amazon SES</option>
                                            <option value="mailgun">Mailgun</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Letter Configuration</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label for="letterProvider">Letter Provider</label>
                                        <select id="letterProvider" name="letterProvider">
                                            <option value="lob" selected>Lob</option>
                                            <option value="postalytics">Postalytics</option>
                                            <option value="manual">Manual (No automation)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="defaultCertified" name="defaultCertified" checked>
                                            Default to certified mail for legal notices
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </section>
                        
                        <!-- Integrations -->
                        <section id="integrations" class="settings-section">
                            <h2>Integrations</h2>
                            <p class="section-description">Connect third-party services and APIs.</p>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">GitHub Integration</h3>
                                    <span class="badge badge-success">Connected</span>
                                </div>
                                <div class="card-body">
                                    <p>Track commits, PRs, and development activity.</p>
                                    <div class="form-group">
                                        <label for="githubRepo">Repository</label>
                                        <input type="text" id="githubRepo" name="githubRepo" value="111-venture-studio/legacy" readonly>
                                    </div>
                                    <button type="button" class="btn btn-secondary">Reconfigure</button>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Vertex AI</h3>
                                    <span class="badge badge-info">Configured</span>
                                </div>
                                <div class="card-body">
                                    <p>AI-powered guidance and document analysis.</p>
                                    <div class="form-group">
                                        <label for="vertexModel">Model</label>
                                        <select id="vertexModel" name="vertexModel">
                                            <option value="gemini-pro" selected>Gemini Pro</option>
                                            <option value="claude-3">Claude 3</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Cloud Storage</h3>
                                    <span class="badge badge-success">Active</span>
                                </div>
                                <div class="card-body">
                                    <p>Firebase Cloud Storage for document vault.</p>
                                    <div class="form-row two-col">
                                        <div class="form-group">
                                            <label>Storage Used</label>
                                            <div class="stat-value">2.4 GB</div>
                                        </div>
                                        <div class="form-group">
                                            <label>Storage Limit</label>
                                            <div class="stat-value">100 GB</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                        
                        <!-- Billing -->
                        <section id="billing" class="settings-section">
                            <h2>Billing</h2>
                            <p class="section-description">Manage subscription and billing information.</p>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Current Plan</h3>
                                </div>
                                <div class="card-body">
                                    <div class="plan-info">
                                        <h4>Enterprise Plan</h4>
                                        <p>Unlimited estates, users, and documents</p>
                                        <p class="text-gold">$499/month</p>
                                    </div>
                                    <button type="button" class="btn btn-secondary">Manage Subscription</button>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Usage This Month</h3>
                                </div>
                                <div class="card-body">
                                    <div class="stats-grid mini">
                                        <div class="stat-card mini">
                                            <div class="stat-value">147</div>
                                            <div class="stat-label">API Calls</div>
                                        </div>
                                        <div class="stat-card mini">
                                            <div class="stat-value">23</div>
                                            <div class="stat-label">Letters Sent</div>
                                        </div>
                                        <div class="stat-card mini">
                                            <div class="stat-value">89</div>
                                            <div class="stat-label">Emails Sent</div>
                                        </div>
                                        <div class="stat-card mini">
                                            <div class="stat-value">2.4 GB</div>
                                            <div class="stat-label">Storage</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                        
                        <!-- Compliance -->
                        <section id="compliance" class="settings-section">
                            <h2>Compliance</h2>
                            <p class="section-description">State-specific probate rules and compliance settings.</p>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Enabled States</h3>
                                </div>
                                <div class="card-body">
                                    <p class="mb-md">MyShepherd currently supports these states:</p>
                                    <div class="state-grid">
                                        <div class="state-item active">
                                            <span class="state-badge">IL</span>
                                            <span>Illinois</span>
                                            <span class="badge badge-success mini">Active</span>
                                        </div>
                                        <div class="state-item active">
                                            <span class="state-badge">MI</span>
                                            <span>Michigan</span>
                                            <span class="badge badge-success mini">Active</span>
                                        </div>
                                        <div class="state-item active">
                                            <span class="state-badge">MN</span>
                                            <span>Minnesota</span>
                                            <span class="badge badge-success mini">Active</span>
                                        </div>
                                        <div class="state-item active">
                                            <span class="state-badge">DC</span>
                                            <span>Washington D.C.</span>
                                            <span class="badge badge-success mini">Active</span>
                                        </div>
                                        <div class="state-item active">
                                            <span class="state-badge">VA</span>
                                            <span>Virginia</span>
                                            <span class="badge badge-success mini">Active</span>
                                        </div>
                                        <div class="state-item active">
                                            <span class="state-badge">MD</span>
                                            <span>Maryland</span>
                                            <span class="badge badge-success mini">Active</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Data Retention</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label for="dataRetention">Retain closed estate data for</label>
                                        <select id="dataRetention" name="dataRetention">
                                            <option value="7">7 years (recommended)</option>
                                            <option value="10">10 years</option>
                                            <option value="0">Indefinitely</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="checkbox-label">
                                            <input type="checkbox" id="auditLogging" name="auditLogging" checked>
                                            Enable audit logging for all actions
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </section>
                        
                        <!-- Advanced -->
                        <section id="advanced" class="settings-section">
                            <h2>Advanced Settings</h2>
                            <p class="section-description">Developer options and system configuration.</p>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Firebase Configuration</h3>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label>Project ID</label>
                                        <input type="text" value="legacy-estate-os" readonly class="readonly">
                                    </div>
                                    <div class="form-group">
                                        <label>Environment</label>
                                        <span class="badge badge-warning">Development</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">System Actions</h3>
                                </div>
                                <div class="card-body">
                                    <div class="action-row">
                                        <div>
                                            <strong>Clear Cache</strong>
                                            <p class="text-muted">Clear local storage and cached data</p>
                                        </div>
                                        <button type="button" class="btn btn-secondary" onclick="clearCache()">Clear Cache</button>
                                    </div>
                                    <div class="action-row">
                                        <div>
                                            <strong>Export All Data</strong>
                                            <p class="text-muted">Download all estates, users, and documents</p>
                                        </div>
                                        <button type="button" class="btn btn-secondary" onclick="exportAllData()">Export</button>
                                    </div>
                                    <div class="action-row danger">
                                        <div>
                                            <strong>Reset to Defaults</strong>
                                            <p class="text-muted">Reset all settings to default values</p>
                                        </div>
                                        <button type="button" class="btn btn-danger" onclick="resetToDefaults()">Reset</button>
                                    </div>
                                </div>
                            </div>
                        </section>
                        
                        <!-- Save Button -->
                        <div class="settings-actions">
                            <button type="button" class="btn btn-secondary" onclick="resetForm()">Reset Changes</button>
                            <button type="button" class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script src="../components/sidebar.js"></script>
    <script src="../components/universal-header.js"></script>
    
    <script type="module">
        import { DatabaseService } from '../assets/js/firebase-init.js';
        
        window.DatabaseService = DatabaseService;
        
        let settings = {};
        
        async function init() {
            console.log('ðŸ›ï¸ MyShepherd - Settings');
            await loadSettings();
        }
        
        async function loadSettings() {
            try {
                const docs = await DatabaseService.getDocuments('settings');
                if (docs.length > 0) {
                    settings = docs[0];
                    applySettings(settings);
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        }
        
        function applySettings(s) {
            // Apply loaded settings to form fields
            Object.keys(s).forEach(key => {
                const el = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
                if (el) {
                    if (el.type === 'checkbox') {
                        el.checked = s[key];
                    } else if (el.type === 'radio') {
                        document.querySelector(`[name="${key}"][value="${s[key]}"]`)?.click();
                    } else {
                        el.value = s[key];
                    }
                }
            });
        }
        
        window.showSection = function(sectionId) {
            // Update nav
            document.querySelectorAll('.settings-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.closest('.settings-nav-item').classList.add('active');
            
            // Update sections
            document.querySelectorAll('.settings-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            event.preventDefault();
        };
        
        window.saveSettings = async function() {
            const formData = {};
            
            // Collect all form data
            document.querySelectorAll('.settings-content input, .settings-content select').forEach(el => {
                if (el.type === 'checkbox') {
                    formData[el.name || el.id] = el.checked;
                } else if (el.type === 'radio') {
                    if (el.checked) formData[el.name] = el.value;
                } else if (el.value && !el.readOnly) {
                    formData[el.name || el.id] = el.value;
                }
            });
            
            try {
                if (settings.id) {
                    await DatabaseService.updateDocument('settings', settings.id, formData);
                } else {
                    await DatabaseService.createDocument('settings', formData);
                }
                showToast('Settings saved successfully', 'success');
            } catch (error) {
                console.error('Error saving settings:', error);
                showToast('Failed to save settings', 'error');
            }
        };
        
        window.resetForm = function() {
            if (confirm('Reset all changes?')) {
                applySettings(settings);
                showToast('Changes reset', 'info');
            }
        };
        
        window.clearCache = function() {
            if (confirm('Clear all cached data?')) {
                localStorage.clear();
                sessionStorage.clear();
                showToast('Cache cleared', 'success');
            }
        };
        
        window.exportAllData = async function() {
            try {
                const estates = await DatabaseService.getDocuments('estates');
                const users = await DatabaseService.getDocuments('users');
                const documents = await DatabaseService.getDocuments('documents');
                
                const exportData = { estates, users, documents, exportedAt: new Date().toISOString() };
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `legacy-export-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                showToast('Export complete', 'success');
            } catch (error) {
                console.error('Error exporting:', error);
                showToast('Export failed', 'error');
            }
        };
        
        window.resetToDefaults = async function() {
            if (!confirm('This will reset ALL settings to defaults. Are you sure?')) return;
            if (!confirm('This action cannot be undone. Continue?')) return;
            
            try {
                if (settings.id) {
                    await DatabaseService.deleteDocument('settings', settings.id);
                }
                location.reload();
            } catch (error) {
                console.error('Error resetting:', error);
                showToast('Reset failed', 'error');
            }
        };
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
