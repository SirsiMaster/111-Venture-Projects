<!DOCTYPE html>
<html lang="en" data-auth-protect="admin">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>User Management ‚Äî FinalWishes</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- FinalWishes Design System -->
    <link rel="stylesheet" href="../legacy.css">
    <link rel="stylesheet" href="../assets/css/admin-layout.css">
</head>
<body>
    <div class="admin-wrapper">
        <!-- Sidebar Component -->
        <div id="sidebar-root" data-active="users"></div>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Header Component -->
            <header id="universal-header-root" 
                    data-title="User Management" 
                    data-subtitle="Manage principals, executors, and heirs"
                    data-search-placeholder="Search users by name, email, or role..."></header>
            
            <!-- Page Content -->
            <div class="page-content">
                <!-- Toolbar -->
                <div class="toolbar">
                    <div class="toolbar-left">
                        <button class="btn btn-primary" onclick="showCreateModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="8.5" cy="7" r="4"></circle>
                                <line x1="20" y1="8" x2="20" y2="14"></line>
                                <line x1="23" y1="11" x2="17" y2="11"></line>
                            </svg>
                            Add User
                        </button>
                        <div class="filter-group">
                            <select id="roleFilter" class="form-select" onchange="filterUsers()">
                                <option value="">All Roles</option>
                                <option value="principal">Principal</option>
                                <option value="executor">Executor</option>
                                <option value="heir">Heir</option>
                                <option value="admin">Admin</option>
                            </select>
                            <select id="statusFilter" class="form-select" onchange="filterUsers()">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="pending">Pending Invite</option>
                                <option value="disabled">Disabled</option>
                            </select>
                        </div>
                    </div>
                    <div class="toolbar-right">
                        <button class="btn btn-secondary" onclick="exportUsers()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Export
                        </button>
                    </div>
                </div>
                
                <!-- Stats Summary -->
                <div class="stats-grid mini">
                    <div class="stat-card mini">
                        <div class="stat-value" id="stat-total">0</div>
                        <div class="stat-label">Total Users</div>
                    </div>
                    <div class="stat-card mini">
                        <div class="stat-value" id="stat-principals">0</div>
                        <div class="stat-label">Principals</div>
                    </div>
                    <div class="stat-card mini">
                        <div class="stat-value" id="stat-executors">0</div>
                        <div class="stat-label">Executors</div>
                    </div>
                    <div class="stat-card mini">
                        <div class="stat-value" id="stat-heirs">0</div>
                        <div class="stat-label">Heirs</div>
                    </div>
                </div>
                
                <!-- Users Table -->
                <div class="data-table">
                    <table>
                        <thead>
                            <tr>
                                <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                                <th onclick="sortBy('name')">Name <span class="sort-icon">‚Üï</span></th>
                                <th onclick="sortBy('email')">Email <span class="sort-icon">‚Üï</span></th>
                                <th onclick="sortBy('role')">Role <span class="sort-icon">‚Üï</span></th>
                                <th onclick="sortBy('estateName')">Estate <span class="sort-icon">‚Üï</span></th>
                                <th onclick="sortBy('status')">Status <span class="sort-icon">‚Üï</span></th>
                                <th onclick="sortBy('lastLogin')">Last Login <span class="sort-icon">‚Üï</span></th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: var(--space-xl);">
                                    <div class="skeleton" style="height: 20px; margin-bottom: 8px;"></div>
                                    <div class="skeleton" style="height: 20px; margin-bottom: 8px;"></div>
                                    <div class="skeleton" style="height: 20px;"></div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                <div class="pagination" id="pagination"></div>
            </div>
        </main>
    </div>
    
    <!-- Create/Edit User Modal -->
    <div class="modal" id="userModal">
        <div class="modal-backdrop" onclick="closeModal()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add New User</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <form id="userForm" onsubmit="handleSubmit(event)">
                <div class="modal-body">
                    <div class="form-row two-col">
                        <div class="form-group">
                            <label for="firstName">First Name *</label>
                            <input type="text" id="firstName" name="firstName" required>
                        </div>
                        <div class="form-group">
                            <label for="lastName">Last Name *</label>
                            <input type="text" id="lastName" name="lastName" required>
                        </div>
                    </div>
                    <div class="form-row two-col">
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" name="email" required>
                        </div>
                        <div class="form-group">
                            <label for="phone">Phone</label>
                            <input type="tel" id="phone" name="phone">
                        </div>
                    </div>
                    <div class="form-row two-col">
                        <div class="form-group">
                            <label for="role">Role *</label>
                            <select id="role" name="role" required>
                                <option value="">Select role</option>
                                <option value="principal">Principal</option>
                                <option value="executor">Executor</option>
                                <option value="heir">Heir</option>
                                <option value="admin">Admin</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="estate">Associated Estate</label>
                            <select id="estate" name="estateId">
                                <option value="">Select estate</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status" name="status">
                            <option value="active">Active</option>
                            <option value="pending">Pending Invite</option>
                            <option value="disabled">Disabled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="sendInvite" name="sendInvite" checked>
                            Send invitation email to user
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="submitBtn">Add User</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- Load Component Scripts -->
    <script src="../components/sidebar.js"></script>
    <script src="../components/universal-header.js"></script>
    
    <!-- Firebase SDK & Logic -->
    <script type="module">
        import { AuthService, DatabaseService } from '../assets/js/firebase-init.js';
        import EstateService from '../assets/js/services/estateService.js';
        
        window.AuthService = AuthService;
        window.DatabaseService = DatabaseService;
        
        let users = [];
        let filteredUsers = [];
        let estates = [];
        let currentPage = 1;
        let pageSize = 10;
        let sortField = 'createdAt';
        let sortDirection = 'desc';
        let editingUserId = null;
        
        async function init() {
            console.log('üèõÔ∏è FinalWishes - User Management');
            await loadEstates();
            await loadUsers();
        }
        
        async function loadEstates() {
            try {
                estates = await EstateService.getAllEstates();
                const select = document.getElementById('estate');
                select.innerHTML = '<option value="">Select estate</option>' +
                    estates.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
            } catch (error) {
                console.error('Error loading estates:', error);
            }
        }
        
        async function loadUsers() {
            try {
                users = await DatabaseService.getDocuments('users');
                filteredUsers = [...users];
                updateStats();
                renderUsers();
            } catch (error) {
                console.error('Error loading users:', error);
                showToast('Failed to load users', 'error');
            }
        }
        
        function updateStats() {
            document.getElementById('stat-total').textContent = users.length;
            document.getElementById('stat-principals').textContent = users.filter(u => u.role === 'principal').length;
            document.getElementById('stat-executors').textContent = users.filter(u => u.role === 'executor').length;
            document.getElementById('stat-heirs').textContent = users.filter(u => u.role === 'heir').length;
        }
        
        function renderUsers() {
            const tbody = document.getElementById('users-table-body');
            const start = (currentPage - 1) * pageSize;
            const pageUsers = filteredUsers.slice(start, start + pageSize);
            
            if (pageUsers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: var(--space-xl);">
                            <div style="color: var(--text-secondary);">No users found.</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = pageUsers.map(user => {
                const estate = estates.find(e => e.id === user.estateId);
                const lastLogin = user.lastLogin?.toDate?.() || null;
                const lastLoginStr = lastLogin ? lastLogin.toLocaleDateString() : 'Never';
                const statusClass = getStatusClass(user.status);
                const roleClass = getRoleClass(user.role);
                
                return `
                    <tr>
                        <td><input type="checkbox" class="user-checkbox" data-id="${user.id}"></td>
                        <td>
                            <div class="user-info">
                                <div class="avatar">${getInitials(user.firstName, user.lastName)}</div>
                                <div>
                                    <strong>${user.firstName} ${user.lastName}</strong>
                                </div>
                            </div>
                        </td>
                        <td>${user.email}</td>
                        <td><span class="badge ${roleClass}">${capitalize(user.role)}</span></td>
                        <td>${estate?.name || '‚Äî'}</td>
                        <td><span class="badge ${statusClass}">${capitalize(user.status || 'active')}</span></td>
                        <td>${lastLoginStr}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-icon btn-sm" onclick="editUser('${user.id}')" title="Edit">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                <button class="btn btn-icon btn-sm" onclick="resetPassword('${user.email}')" title="Reset Password">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                        <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                                    </svg>
                                </button>
                                <button class="btn btn-icon btn-sm btn-danger" onclick="deleteUser('${user.id}')" title="Delete">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="3 6 5 6 21 6"></polyline>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            renderPagination();
        }
        
        function renderPagination() {
            const totalPages = Math.ceil(filteredUsers.length / pageSize);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            pagination.innerHTML = `
                <button class="btn btn-sm btn-secondary" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">Previous</button>
                <span class="pagination-info">Page ${currentPage} of ${totalPages}</span>
                <button class="btn btn-sm btn-secondary" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">Next</button>
            `;
        }
        
        window.filterUsers = function() {
            const role = document.getElementById('roleFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            filteredUsers = users.filter(user => {
                if (role && user.role !== role) return false;
                if (status && user.status !== status) return false;
                return true;
            });
            
            currentPage = 1;
            renderUsers();
        };
        
        window.sortBy = function(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'asc';
            }
            
            filteredUsers.sort((a, b) => {
                const aVal = a[field] || '';
                const bVal = b[field] || '';
                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            renderUsers();
        };
        
        window.goToPage = function(page) {
            currentPage = page;
            renderUsers();
        };
        
        window.toggleSelectAll = function() {
            const checked = document.getElementById('selectAll').checked;
            document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = checked);
        };
        
        window.showCreateModal = function() {
            editingUserId = null;
            document.getElementById('modalTitle').textContent = 'Add New User';
            document.getElementById('submitBtn').textContent = 'Add User';
            document.getElementById('userForm').reset();
            document.getElementById('userModal').classList.add('open');
        };
        
        window.editUser = function(id) {
            const user = users.find(u => u.id === id);
            if (!user) return;
            
            editingUserId = id;
            document.getElementById('modalTitle').textContent = 'Edit User';
            document.getElementById('submitBtn').textContent = 'Save Changes';
            
            document.getElementById('firstName').value = user.firstName || '';
            document.getElementById('lastName').value = user.lastName || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('phone').value = user.phone || '';
            document.getElementById('role').value = user.role || '';
            document.getElementById('estate').value = user.estateId || '';
            document.getElementById('status').value = user.status || 'active';
            document.getElementById('sendInvite').checked = false;
            
            document.getElementById('userModal').classList.add('open');
        };
        
        window.closeModal = function() {
            document.getElementById('userModal').classList.remove('open');
            editingUserId = null;
        };
        
        window.handleSubmit = async function(event) {
            event.preventDefault();
            
            const form = event.target;
            const data = {
                firstName: form.firstName.value,
                lastName: form.lastName.value,
                email: form.email.value,
                phone: form.phone.value,
                role: form.role.value,
                estateId: form.estateId.value,
                status: form.status.value,
            };
            
            try {
                if (editingUserId) {
                    await DatabaseService.updateDocument('users', editingUserId, data);
                    showToast('User updated successfully', 'success');
                } else {
                    data.createdAt = new Date();
                    await DatabaseService.createDocument('users', data);
                    showToast('User created successfully', 'success');
                    
                    if (form.sendInvite.checked) {
                        // TODO: Send invitation email via Cloud Function
                        console.log('Would send invite to:', data.email);
                    }
                }
                
                closeModal();
                await loadUsers();
            } catch (error) {
                console.error('Error saving user:', error);
                showToast('Failed to save user', 'error');
            }
        };
        
        window.resetPassword = async function(email) {
            if (!confirm(`Send password reset email to ${email}?`)) return;
            try {
                await AuthService.sendPasswordReset(email);
                showToast('Password reset email sent', 'success');
            } catch (error) {
                console.error('Error sending reset:', error);
                showToast('Failed to send reset email', 'error');
            }
        };
        
        window.deleteUser = async function(id) {
            if (!confirm('Are you sure you want to delete this user?')) return;
            try {
                await DatabaseService.deleteDocument('users', id);
                showToast('User deleted successfully', 'success');
                await loadUsers();
            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('Failed to delete user', 'error');
            }
        };
        
        window.exportUsers = function() {
            const csv = [
                ['Name', 'Email', 'Role', 'Estate', 'Status', 'Last Login'].join(','),
                ...filteredUsers.map(u => [
                    `${u.firstName} ${u.lastName}`,
                    u.email,
                    u.role,
                    estates.find(e => e.id === u.estateId)?.name || '',
                    u.status,
                    u.lastLogin?.toDate?.().toISOString() || ''
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `users-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        };
        
        function capitalize(str) {
            return str ? str.charAt(0).toUpperCase() + str.slice(1) : '';
        }
        
        function getInitials(first, last) {
            return ((first?.[0] || '') + (last?.[0] || '')).toUpperCase() || '??';
        }
        
        function getStatusClass(status) {
            const map = { active: 'badge-success', pending: 'badge-warning', disabled: 'badge-neutral' };
            return map[status] || 'badge-neutral';
        }
        
        function getRoleClass(role) {
            const map = { admin: 'badge-danger', principal: 'badge-gold', executor: 'badge-info', heir: 'badge-success' };
            return map[role] || 'badge-neutral';
        }
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
