<!DOCTYPE html>
<html lang="en" data-auth-protect="admin">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Development Reports ‚Äî FinalWishes</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="../../finalwishes.css">
    
</head>
<body>
    <div class="admin-wrapper">
        <div id="sidebar-root" data-active="dev-reports"></div>
        
        <main class="main-content">
            <header id="universal-header-root" 
                    data-title="Development Reports" 
                    data-subtitle="Generate and export development reports"
                    data-search-placeholder="Search sessions..."></header>
            
            <div class="page-content">
                <!-- Report Generator -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Generate Report</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-row three-col">
                            <div class="form-group">
                                <label for="reportType">Report Type</label>
                                <select id="reportType" class="form-select">
                                    <option value="summary">Executive Summary</option>
                                    <option value="detailed">Detailed Activity Log</option>
                                    <option value="costs">Cost Analysis</option>
                                    <option value="velocity">Velocity Report</option>
                                    <option value="agent">Agent Performance</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="dateFrom">From Date</label>
                                <input type="date" id="dateFrom" class="form-input">
                            </div>
                            <div class="form-group">
                                <label for="dateTo">To Date</label>
                                <input type="date" id="dateTo" class="form-input">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="exportFormat">Export Format</label>
                                <div class="radio-group">
                                    <label class="radio-label"><input type="radio" name="format" value="csv" checked> CSV</label>
                                    <label class="radio-label"><input type="radio" name="format" value="json"> JSON</label>
                                    <label class="radio-label"><input type="radio" name="format" value="pdf"> PDF</label>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="generateReport()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                <polyline points="7 10 12 15 17 10"></polyline>
                                <line x1="12" y1="15" x2="12" y2="3"></line>
                            </svg>
                            Generate & Download
                        </button>
                    </div>
                </div>
                
                <!-- All Sessions -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">All Development Sessions</h3>
                        <div class="filter-group">
                            <select id="agentFilter" class="form-select" onchange="filterSessions()">
                                <option value="">All Agents</option>
                                <option value="auth">Auth</option>
                                <option value="estate">Estate</option>
                                <option value="vault">Vault</option>
                                <option value="compliance">Compliance</option>
                                <option value="notify">Notify</option>
                                <option value="llm">LLM</option>
                                <option value="general">General</option>
                            </select>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="data-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th onclick="sortBy('date')">Date <span class="sort-icon">‚Üï</span></th>
                                        <th onclick="sortBy('hours')">Hours <span class="sort-icon">‚Üï</span></th>
                                        <th onclick="sortBy('commits')">Commits <span class="sort-icon">‚Üï</span></th>
                                        <th onclick="sortBy('files')">Files <span class="sort-icon">‚Üï</span></th>
                                        <th onclick="sortBy('lines')">Lines +/-</th>
                                        <th>Agent</th>
                                        <th>Cost</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="sessions-table">
                                    <!-- Populated by JS -->
                                </tbody>
                            </table>
                        </div>
                        <div class="pagination" id="pagination"></div>
                    </div>
                </div>
                
                <!-- Summary Stats -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Period Summary</h3>
                    </div>
                    <div class="card-body">
                        <div class="stats-grid mini">
                            <div class="stat-card mini">
                                <div class="stat-value" id="sum-sessions">0</div>
                                <div class="stat-label">Sessions</div>
                            </div>
                            <div class="stat-card mini">
                                <div class="stat-value" id="sum-hours">0</div>
                                <div class="stat-label">Total Hours</div>
                            </div>
                            <div class="stat-card mini">
                                <div class="stat-value" id="sum-commits">0</div>
                                <div class="stat-label">Commits</div>
                            </div>
                            <div class="stat-card mini">
                                <div class="stat-value" id="sum-cost">$0</div>
                                <div class="stat-label">Total Cost</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script src="../../components/sidebar.js?v=5.0.2"></script>
    <script src="../../components/universal-header.js?v=5.0.2"></script>
    
    <script type="module">
        import DevelopmentMetricsService from '../../assets/js/services/developmentMetricsService.js';
        
        window.MetricsService = DevelopmentMetricsService;
        
        let sessions = [];
        let filteredSessions = [];
        let currentPage = 1;
        let pageSize = 20;
        let sortField = 'date';
        let sortDirection = 'desc';
        
        async function init() {
            console.log('üèõÔ∏è FinalWishes - Development Reports');
            
            // Set default dates
            const today = new Date();
            const monthAgo = new Date();
            monthAgo.setMonth(monthAgo.getMonth() - 1);
            document.getElementById('dateTo').valueAsDate = today;
            document.getElementById('dateFrom').valueAsDate = monthAgo;
            
            await loadSessions();
        }
        
        async function loadSessions() {
            try {
                sessions = await DevelopmentMetricsService.getAllSessions();
                filteredSessions = [...sessions];
                renderSessions();
                updateSummary();
            } catch (error) {
                console.error('Error loading sessions:', error);
                useFallbackData();
            }
        }
        
        function useFallbackData() {
            sessions = [
                { date: new Date('2025-11-26'), hours: 4.5, commits: 8, files: 23, lines: 547, agent: 'Admin', rate: 150, notes: 'Admin dashboard implementation' },
                { date: new Date('2025-11-25'), hours: 6.0, commits: 12, files: 31, lines: 892, agent: 'Estate', rate: 150, notes: 'Estate service, Firebase integration' },
                { date: new Date('2025-11-24'), hours: 5.5, commits: 9, files: 18, lines: 423, agent: 'General', rate: 150, notes: 'Component library foundation' },
                { date: new Date('2025-11-23'), hours: 3.0, commits: 5, files: 12, lines: 234, agent: 'Auth', rate: 150, notes: 'Auth system setup' },
                { date: new Date('2025-11-22'), hours: 7.0, commits: 15, files: 42, lines: 1203, agent: 'General', rate: 150, notes: 'Initial project setup, architecture' },
            ];
            filteredSessions = [...sessions];
            renderSessions();
            updateSummary();
        }
        
        function renderSessions() {
            const tbody = document.getElementById('sessions-table');
            const start = (currentPage - 1) * pageSize;
            const pageSessions = filteredSessions.slice(start, start + pageSize);
            
            if (pageSessions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No sessions found</td></tr>';
                return;
            }
            
            tbody.innerHTML = pageSessions.map(s => {
                const date = s.date?.toDate?.() || s.date;
                const dateStr = date.toLocaleDateString();
                const cost = (s.hours * (s.rate || 150)).toLocaleString();
                const linesClass = s.lines >= 0 ? 'positive' : 'negative';
                
                return `
                    <tr>
                        <td>${dateStr}</td>
                        <td>${s.hours}h</td>
                        <td>${s.commits || 0}</td>
                        <td>${s.files || 0}</td>
                        <td class="${linesClass}">${s.lines >= 0 ? '+' : ''}${s.lines || 0}</td>
                        <td>${s.agent || 'General'}</td>
                        <td>$${cost}</td>
                        <td class="truncate" title="${s.notes || ''}">${s.notes || '‚Äî'}</td>
                    </tr>
                `;
            }).join('');
            
            renderPagination();
        }
        
        function renderPagination() {
            const totalPages = Math.ceil(filteredSessions.length / pageSize);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            pagination.innerHTML = `
                <button class="btn btn-sm btn-secondary" ${currentPage === 1 ? 'disabled' : ''} onclick="goToPage(${currentPage - 1})">Previous</button>
                <span class="pagination-info">Page ${currentPage} of ${totalPages}</span>
                <button class="btn btn-sm btn-secondary" ${currentPage === totalPages ? 'disabled' : ''} onclick="goToPage(${currentPage + 1})">Next</button>
            `;
        }
        
        function updateSummary() {
            const sum = filteredSessions.reduce((acc, s) => ({
                hours: acc.hours + s.hours,
                commits: acc.commits + (s.commits || 0),
                cost: acc.cost + (s.hours * (s.rate || 150)),
            }), { hours: 0, commits: 0, cost: 0 });
            
            document.getElementById('sum-sessions').textContent = filteredSessions.length;
            document.getElementById('sum-hours').textContent = sum.hours.toFixed(1);
            document.getElementById('sum-commits').textContent = sum.commits;
            document.getElementById('sum-cost').textContent = '$' + sum.cost.toLocaleString();
        }
        
        window.filterSessions = function() {
            const agent = document.getElementById('agentFilter').value;
            filteredSessions = agent ? sessions.filter(s => s.agent?.toLowerCase() === agent) : [...sessions];
            currentPage = 1;
            renderSessions();
            updateSummary();
        };
        
        window.sortBy = function(field) {
            if (sortField === field) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortDirection = 'desc';
            }
            
            filteredSessions.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                if (field === 'date') {
                    aVal = aVal?.getTime?.() || 0;
                    bVal = bVal?.getTime?.() || 0;
                }
                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
            
            renderSessions();
        };
        
        window.goToPage = function(page) {
            currentPage = page;
            renderSessions();
        };
        
        window.generateReport = function() {
            const type = document.getElementById('reportType').value;
            const from = document.getElementById('dateFrom').value;
            const to = document.getElementById('dateTo').value;
            const format = document.querySelector('input[name="format"]:checked').value;
            
            showToast('Generating report...', 'info');
            
            setTimeout(() => {
                const filtered = sessions.filter(s => {
                    const date = s.date?.toDate?.() || s.date;
                    return date >= new Date(from) && date <= new Date(to);
                });
                
                let content, filename, mimeType;
                
                if (format === 'csv') {
                    content = [
                        ['Date', 'Hours', 'Commits', 'Files', 'Lines', 'Agent', 'Cost', 'Notes'].join(','),
                        ...filtered.map(s => [
                            (s.date?.toDate?.() || s.date).toISOString().split('T')[0],
                            s.hours,
                            s.commits || 0,
                            s.files || 0,
                            s.lines || 0,
                            s.agent || 'General',
                            s.hours * (s.rate || 150),
                            `"${(s.notes || '').replace(/"/g, '""')}"`
                        ].join(','))
                    ].join('\n');
                    filename = `dev-report-${type}-${from}-${to}.csv`;
                    mimeType = 'text/csv';
                } else if (format === 'json') {
                    content = JSON.stringify({ type, from, to, sessions: filtered }, null, 2);
                    filename = `dev-report-${type}-${from}-${to}.json`;
                    mimeType = 'application/json';
                } else {
                    showToast('PDF export coming soon', 'info');
                    return;
                }
                
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                
                showToast('Report downloaded', 'success');
            }, 500);
        };
        
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>
